<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Yield Record | Calamansi Yield System</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        lime: {
                            50: '#f7fee7', 100: '#ecfccb', 500: '#84cc16',
                            600: '#65a30d', 700: '#4d7c0f', 900: '#365314',
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-slate-50 text-slate-800 h-screen flex overflow-hidden">
    <!-- Sidebar Backdrop -->
    <div id="sidebar-backdrop" class="fixed inset-0 bg-black/50 z-20 hidden md:hidden"></div>

  <!---Side bar-->
         <aside id="sidebar" class="w-64 bg-lime-900 text-white fixed inset-y-0 left-0 transform -translate-x-full md:translate-x-0 md:static flex flex-col z-30 flex-shrink-0 transition-all duration-300">
            <div class="p-6 flex items-center justify-between border-b border-lime-800">
                <div class="flex items-center gap-3">
                    <img src="../images/cys_logo.png" alt="CYS Logo" class="w-20 h-20 object-contain"/>
                    <span class="font-bold text-lg tracking-wide">Calamansi Yield System</span>
                </div>
                <button id="sidebar-close" class="md:hidden text-lime-200 hover:text-white">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>
            <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
                <a href="farmer_dashboard.html" class="flex items-center gap-3 px-4 py-3 text-lime-200 hover:bg-lime-800 hover:text-white rounded-xl transition">
                    <i class="fa-solid fa-gauge-high w-5"></i> Dashboard
                </a>
                <a href="add_yield_record.html" class="flex items-center gap-3 px-4 py-3 bg-lime-800 rounded-xl text-white font-medium shadow-inner">
                    <i class="fa-solid fa-plus w-5"></i> Add Yield Record
                </a>
                <a href="farmer_yield_history.html" class="flex items-center gap-3 px-4 py-3 text-lime-200 hover:bg-lime-800 hover:text-white rounded-xl transition">
                    <i class="fa-solid fa-chart-line w-5"></i> Yield History
                </a>
                <a href="farmer_settings.html" class="flex items-center gap-3 px-4 py-3 text-lime-200 hover:bg-lime-800 hover:text-white rounded-xl transition">
                    <i class="fa-solid fa-gear w-5"></i> Settings
                </a>
            </nav>
            
            <div class="p-4 border-t border-lime-800">
                <div class="flex items-center gap-3 p-3 rounded-lg bg-lime-800/50">
                    <img id="sidebar-avatar" src="https://api.dicebear.com/7.x/avataaars/svg?seed=Farmer" class="w-8 h-8 rounded-full bg-white" alt="Farmer">
                    
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-white truncate" id="user-display-name">Farmer</p>
                        <p class="text-xs text-lime-300 truncate" id="user-display-email">Loading...</p>
                    </div>
                    
                    <button id="btn-logout-trigger" class="text-lime-300 hover:text-white transition-colors p-2 rounded-md hover:bg-lime-700/50" title="Sign Out">
                        <i class="fa-solid fa-right-from-bracket"></i>
                    </button>
                </div>
            </div>
        </aside>

    <main class="flex-1 flex flex-col min-w-0 overflow-hidden">
        
        <header class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-6 z-10 flex-shrink-0">
            <div class="flex items-center gap-2 md:hidden">
                <button id="sidebar-toggle" class="text-slate-600"><i class="fa-solid fa-bars text-xl"></i></button>
                <span class="font-bold text-lime-900">Add Record</span>
            </div>
            <div class="hidden md:block">
                <h1 class="text-xl font-bold text-slate-800">Add Yield Record</h1>
            </div>
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 bg-lime-100 rounded-full flex items-center justify-center text-lime-700">
                    <i class="fa-solid fa-bell"></i>
                </div>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-4 md:p-8">
            <div class="max-w-2xl mx-auto">
                <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-6 md:p-8">
                    <form id="yieldForm">
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Batch ID</label>
                                <input type="text" id="batchId" readonly class="w-full px-4 py-3 bg-slate-50 border border-slate-300 rounded-lg text-slate-500 cursor-not-allowed">
                                <p class="mt-2 text-sm text-slate-500">Auto-generated unique identifier for this yield batch</p>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Yield Amount (kg)</label>
                                <input type="number" id="yieldAmount" min="0" step="0.01" required class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-lime-500 focus:border-lime-500">
                                <p class="mt-2 text-sm text-slate-500">Enter the total yield amount in kilograms</p>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Harvest Date</label>
                                <input type="date" id="harvestDate" required class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-lime-500 focus:border-lime-500">
                                <p class="mt-2 text-sm text-slate-500">Date when the calamansi was harvested</p>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Quality Grade</label>
                                <select id="qualityGrade" required class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-lime-500 focus:border-lime-500">
                                    <option value="">Select Quality Grade</option>
                                    <option value="Premium">Premium</option>
                                    <option value="Standard">Standard</option>
                                    <option value="Economy">Economy</option>
                                </select>
                                <p class="mt-2 text-sm text-slate-500">Quality classification of the harvested calamansi</p>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Status</label>
                                <select id="status" required class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-lime-500 focus:border-lime-500">
                                    <option value="pending">Pending</option>
                                    <option value="approved">Approved</option>
                                    <option value="rejected">Rejected</option>
                                </select>
                                <p class="mt-2 text-sm text-slate-500">Current status of this yield record</p>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Notes</label>
                                <textarea id="notes" rows="4" placeholder="Additional information about this yield record..." class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-lime-500 focus:border-lime-500"></textarea>
                                <p class="mt-2 text-sm text-slate-500">Any additional notes or observations about this yield</p>
                            </div>

                            <div class="pt-4">
                                <button type="submit" id="submitBtn" class="w-full bg-lime-600 hover:bg-lime-700 text-white py-3 px-4 rounded-lg font-bold transition shadow-lg shadow-lime-200">
                                    Submit Yield Record
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        import { app } from '../firebase-config.js';
        import { initAuthSidebar } from '../js/Auth.js';
        import { 
            getAuth, 
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { 
            getFirestore, 
            collection,
            addDoc,
            serverTimestamp,
            query,
            orderBy,
            getDocs
        } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        const auth = getAuth(app);
        const db = getFirestore(app);

        // DOM Elements
        const yieldForm = document.getElementById('yieldForm');
        const batchIdInput = document.getElementById('batchId');
        const submitBtn = document.getElementById('submitBtn');

        initAuthSidebar();

        // Generate batch ID with format YC-2026-XXX
        async function generateBatchId() {
            try {
                const currentYear = new Date().getFullYear();
                const q = query(collection(db, "yield_requests"), orderBy("batchId", "desc"));
                const querySnapshot = await getDocs(q);
                
                let highestNumber = 0;
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.batchId && data.batchId.startsWith(`YC-${currentYear}-`)) {
                        const numberPart = parseInt(data.batchId.split('-')[2]);
                        if (!isNaN(numberPart) && numberPart > highestNumber) {
                            highestNumber = numberPart;
                        }
                    }
                });
                
                const nextNumber = highestNumber + 1;
                const formattedNumber = nextNumber.toString().padStart(3, '0');
                return `YC-${currentYear}-${formattedNumber}`;
            } catch (error) {
                console.error("Error generating batch ID:", error);
                // Fallback: generate a simple incremental ID
                return `YC-${currentYear}-${Math.floor(Math.random() * 1000).toString().padStart(3, '0')}`;
            }
        }

        // Check authentication and generate batch ID
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // Generate batch ID when page loads
                const batchId = await generateBatchId();
                batchIdInput.value = batchId;
            } else {
                window.location.href = '../index.html';
            }
        });

        // Handle form submission
        yieldForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Get form values
            const yieldAmount = parseFloat(document.getElementById('yieldAmount').value);
            const harvestDate = document.getElementById('harvestDate').value;
            const qualityGrade = document.getElementById('qualityGrade').value;
            const status = document.getElementById('status').value;
            const notes = document.getElementById('notes').value;

            // Validate required fields
            if (!yieldAmount || !harvestDate || !qualityGrade || !status) {
                alert('Please fill in all required fields.');
                return;
            }

            // Disable submit button to prevent duplicate submissions
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';

            try {
                // Get current user
                const user = auth.currentUser;
                if (!user) {
                    throw new Error('User not authenticated');
                }

                // Prepare data to save
                const yieldData = {
                    batchId: batchIdInput.value,
                    yieldAmount: yieldAmount,
                    harvestDate: harvestDate,
                    quality: qualityGrade,
                    status: status,
                    notes: notes || '',
                    farmerId: user.uid,
                    farmerName: user.email || 'Farmer',
                    submissionDate: serverTimestamp(),
                    createdAt: serverTimestamp()
                };

                // Save to Firestore
                await addDoc(collection(db, "yield_requests"), yieldData);

                // Show success message and redirect
                alert('Yield record submitted successfully!');
                window.location.href = 'farmer_yield_history.html';
            } catch (error) {
                console.error('Error submitting yield record:', error);
                alert('Error submitting yield record. Please try again.');
            } finally {
                // Re-enable submit button
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Yield Record';
            }
        });
    </script>

    <script type="module">
        import { app } from '../firebase-config.js';
        import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
            
        // Logout functionality
        document.getElementById('btn-logout-trigger').addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('logout-modal').classList.remove('hidden');
        });
            
        document.getElementById('btn-cancel-logout').addEventListener('click', () => {
            document.getElementById('logout-modal').classList.add('hidden');
        });
            
        document.getElementById('btn-confirm-logout').addEventListener('click', async () => {
            const auth = getAuth(app);
            signOut(auth).then(() => {
                window.location.href = '../index.html';
            }).catch((error) => {
                console.error('Logout error:', error);
            });
        });
    </script>


    <!-- LOGOUT MODAL -->
    <div id="logout-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center">
        <div id="logout-backdrop" class="absolute inset-0 bg-black/40 opacity-0"></div>

        <div id="logout-panel"
            class="bg-white p-6 rounded-xl relative opacity-0 transform translate-y-4 transition-all">
            <h3 class="font-bold mb-2">Sign Out</h3>
            <p class="text-sm mb-4">Are you sure you want to log out?</p>

            <div class="flex justify-end gap-2">
                <button id="btn-cancel-logout" class="px-4 py-2 bg-slate-100 rounded">
                    Cancel
                </button>
                <button id="btn-confirm-logout" class="px-4 py-2 bg-red-600 text-white rounded">
                    Sign Out
                </button>
            </div>
        </div>
    </div>

</body>
</html>